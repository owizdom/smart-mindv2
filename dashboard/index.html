<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emergent Swarm Mind v2</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'SF Mono', 'Fira Code', monospace;
      background: #000;
      color: #e0e0e0;
      overflow: hidden;
      height: 100vh;
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 360px;
      grid-template-rows: 50px 1fr 220px;
      height: 100vh;
      gap: 0;
    }

    .header {
      grid-column: 1 / -1;
      background: rgba(10,10,15,0.95);
      border-bottom: 1px solid #1a1a2e;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
    }

    .header h1 {
      font-size: 1em;
      letter-spacing: 3px;
      background: linear-gradient(90deg, #4a9eff, #a855f7, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header-stats {
      display: flex;
      gap: 18px;
      font-size: 0.72em;
    }

    .header-stats .stat { color: #666; }
    .header-stats .stat .val { color: #4a9eff; font-weight: bold; }
    .header-stats .stat.synced .val { color: #a855f7; }
    .header-stats .stat.transition .val { color: #ec4899; }
    .header-stats .stat.tokens .val { color: #f59e0b; }
    .header-stats .stat.prs .val { color: #10b981; }

    /* Canvas area */
    .canvas-area {
      position: relative;
      background: #030308;
      overflow: hidden;
    }

    canvas {
      width: 100%;
      height: 100%;
    }

    /* Density meter overlay */
    .density-meter {
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
      height: 6px;
      background: rgba(255,255,255,0.05);
      border-radius: 3px;
      overflow: hidden;
    }

    .density-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease, background 0.5s ease;
    }

    .density-label {
      position: absolute;
      bottom: 32px;
      left: 20px;
      font-size: 0.65em;
      color: #444;
    }

    .critical-line {
      position: absolute;
      bottom: 20px;
      height: 6px;
      width: 2px;
      background: #ec4899;
      opacity: 0.6;
    }

    /* Phase transition flash */
    .flash {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(circle at center, rgba(168,85,247,0.3), transparent 70%);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .flash.active {
      animation: flashPulse 2s ease-out;
    }

    @keyframes flashPulse {
      0% { opacity: 0.8; }
      100% { opacity: 0; }
    }

    /* PR burst effect */
    @keyframes prBurst {
      0% { transform: scale(0); opacity: 1; }
      100% { transform: scale(3); opacity: 0; }
    }

    .pr-burst {
      position: absolute;
      width: 20px; height: 20px;
      border-radius: 50%;
      border: 2px solid #10b981;
      pointer-events: none;
      animation: prBurst 1s ease-out forwards;
    }

    /* Side panel */
    .side-panel {
      background: rgba(10,10,15,0.95);
      border-left: 1px solid #1a1a2e;
      overflow-y: auto;
      padding: 12px;
    }

    .panel-section {
      margin-bottom: 16px;
    }

    .panel-section h3 {
      font-size: 0.7em;
      color: #444;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 8px;
      padding-bottom: 4px;
      border-bottom: 1px solid #1a1a2e;
    }

    /* Agent list */
    .agent-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 0;
      font-size: 0.72em;
    }

    .agent-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .agent-name { color: #888; min-width: 62px; }
    .agent-action { color: #555; font-size: 0.85em; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .agent-stat { color: #4a9eff; font-size: 0.85em; min-width: 20px; text-align: right; }
    .agent-pr-count { color: #10b981; font-size: 0.85em; min-width: 16px; text-align: right; }
    .agent-item.synced .agent-name { color: #a855f7; }
    .agent-item.synced .agent-dot { box-shadow: 0 0 6px currentColor; }

    /* Thought stream */
    .thought-item {
      padding: 6px 0;
      border-bottom: 1px solid #0a0a12;
      font-size: 0.7em;
    }

    .thought-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }

    .thought-agent { font-weight: bold; }
    .thought-confidence { color: #444; }
    .thought-conclusion { color: #888; line-height: 1.3; }
    .thought-actions { color: #4a9eff; font-size: 0.9em; margin-top: 2px; }

    /* Collective memories */
    .memory-item {
      padding: 8px;
      margin-bottom: 6px;
      border-radius: 6px;
      border: 1px solid #2a1a3e;
      background: rgba(168,85,247,0.05);
    }

    .memory-topic {
      color: #a855f7;
      font-size: 0.8em;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .memory-synthesis {
      color: #888;
      font-size: 0.7em;
      line-height: 1.4;
      max-height: 80px;
      overflow: hidden;
    }

    .memory-meta {
      font-size: 0.65em;
      color: #444;
      margin-top: 4px;
    }

    /* Bottom panel */
    .bottom-panel {
      grid-column: 1 / -1;
      background: rgba(10,10,15,0.95);
      border-top: 1px solid #1a1a2e;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1px;
      overflow: hidden;
    }

    .bottom-section {
      padding: 12px;
      overflow-y: auto;
    }

    .bottom-section h3 {
      font-size: 0.65em;
      color: #444;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 8px;
    }

    /* Decision status colors */
    .decision-status-pending { color: #666; }
    .decision-status-executing { color: #f59e0b; }
    .decision-status-completed { color: #10b981; }
    .decision-status-failed { color: #f43f5e; }

    .empty { color: #333; font-size: 0.75em; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>EMERGENT SWARM MIND v2</h1>
    <div class="header-stats">
      <div class="stat">Step <span class="val" id="h-step">0</span></div>
      <div class="stat">Pheromones <span class="val" id="h-pheromones">0</span></div>
      <div class="stat">Discoveries <span class="val" id="h-discoveries">0</span></div>
      <div class="stat synced">Synced <span class="val" id="h-synced">0/0</span></div>
      <div class="stat tokens">Tokens <span class="val" id="h-tokens">0</span></div>
      <div class="stat prs">PRs <span class="val" id="h-prs">0</span></div>
      <div class="stat transition" id="h-transition-wrap" style="display:none">
        <span class="val">PHASE TRANSITION</span>
      </div>
    </div>
  </div>

  <div class="canvas-area">
    <canvas id="canvas"></canvas>
    <div class="density-meter">
      <div class="density-fill" id="density-fill"></div>
    </div>
    <div class="density-label" id="density-label">Density: 0.000 / threshold: 0.55</div>
    <div class="critical-line" id="critical-line"></div>
    <div class="flash" id="flash"></div>
  </div>

  <div class="side-panel">
    <div class="panel-section">
      <h3>Agents</h3>
      <div id="agent-list"></div>
    </div>
    <div class="panel-section">
      <h3>Collective Memories</h3>
      <div id="collective-list">
        <div class="empty">Waiting for phase transition...</div>
      </div>
    </div>
    <div class="panel-section">
      <h3>Agent Thoughts</h3>
      <div id="thought-feed">
        <div class="empty">Agents thinking...</div>
      </div>
    </div>
  </div>

  <div class="bottom-panel">
    <div class="bottom-section">
      <h3>Decision Log</h3>
      <div id="decision-log"><div class="empty">No decisions yet</div></div>
    </div>
    <div class="bottom-section">
      <h3>GitHub Activity</h3>
      <div id="github-activity"><div class="empty">No GitHub activity yet</div></div>
    </div>
    <div class="bottom-section">
      <h3>Domain Coverage</h3>
      <div id="domain-coverage"><div class="empty">Scanning domains...</div></div>
    </div>
  </div>
</div>

<script>
const API = window.location.origin;
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let agents = [];
let pheromones = [];
let thoughts = [];
let decisions = [];
let prevTransition = false;
let prevPRCount = 0;
let agentColors = {};
const palette = [
  '#4a9eff', '#a855f7', '#ec4899', '#22d3ee',
  '#f59e0b', '#10b981', '#f43f5e', '#8b5cf6'
];

// Pheromone type colors
const pheromoneTypeColors = {
  knowledge: '#4a9eff',
  code: '#10b981',
  pr: '#f59e0b',
  technique: '#a855f7',
};

function resize() {
  const area = canvas.parentElement;
  canvas.width = area.clientWidth * 2;
  canvas.height = area.clientHeight * 2;
  canvas.style.width = area.clientWidth + 'px';
  canvas.style.height = area.clientHeight + 'px';
  ctx.scale(2, 2);
}
resize();
window.addEventListener('resize', resize);

function getColor(agentId, index) {
  if (!agentColors[agentId]) {
    agentColors[agentId] = palette[Object.keys(agentColors).length % palette.length];
  }
  return agentColors[agentId];
}

function getPheromoneColor(p) {
  return pheromoneTypeColors[p.pheromoneType] || pheromoneTypeColors.knowledge;
}

function drawSwarm(agents, pheromones, transitioned) {
  const w = canvas.width / 2;
  const h = canvas.height / 2;

  // Clear with trail effect
  ctx.fillStyle = transitioned ? 'rgba(3,3,8,0.15)' : 'rgba(3,3,8,0.25)';
  ctx.fillRect(0, 0, w, h);

  // Draw pheromone connections
  ctx.lineWidth = 0.5;
  for (const p of pheromones) {
    if (p.strength < 0.2) continue;
    const sourceAgent = agents.find(a => a.id === p.agentId);
    if (!sourceAgent) continue;

    for (const connId of p.connections) {
      const target = pheromones.find(pp => pp.id === connId);
      if (!target) continue;
      const targetAgent = agents.find(a => a.id === target.agentId);
      if (!targetAgent) continue;

      const color = getPheromoneColor(p);
      ctx.strokeStyle = color + Math.round(p.strength * 40).toString(16).padStart(2, '0');
      ctx.beginPath();
      ctx.moveTo(sourceAgent.position.x * w / 1000, sourceAgent.position.y * h / 800);
      ctx.lineTo(targetAgent.position.x * w / 1000, targetAgent.position.y * h / 800);
      ctx.stroke();
    }
  }

  // Draw pheromone particles — color-coded by type
  for (const p of pheromones) {
    if (p.strength < 0.1) continue;
    const agent = agents.find(a => a.id === p.agentId);
    if (!agent) continue;

    const px = agent.position.x * w / 1000 + (Math.random() - 0.5) * 40;
    const py = agent.position.y * h / 800 + (Math.random() - 0.5) * 40;
    const color = getPheromoneColor(p);

    ctx.beginPath();
    ctx.arc(px, py, p.strength * 2.5, 0, Math.PI * 2);
    ctx.fillStyle = color + Math.round(p.strength * 60).toString(16).padStart(2, '0');
    ctx.fill();
  }

  // Draw agents
  for (let i = 0; i < agents.length; i++) {
    const a = agents[i];
    const x = a.position.x * w / 1000;
    const y = a.position.y * h / 800;
    const color = getColor(a.id, i);
    const radius = a.synchronized ? 8 : 5;

    // Glow
    if (a.synchronized) {
      const grad = ctx.createRadialGradient(x, y, 0, x, y, 30);
      grad.addColorStop(0, color + '40');
      grad.addColorStop(1, color + '00');
      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.arc(x, y, 30, 0, Math.PI * 2);
      ctx.fill();
    }

    // Energy ring
    ctx.strokeStyle = color + Math.round(a.energy * 200).toString(16).padStart(2, '0');
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.arc(x, y, radius + 3, 0, Math.PI * 2 * a.energy);
    ctx.stroke();

    // Core
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(x, y, radius, 0, Math.PI * 2);
    ctx.fill();

    // Action label (below agent name)
    ctx.fillStyle = '#444';
    ctx.font = '9px monospace';
    ctx.fillText(a.name, x + radius + 5, y + 3);

    // Show current action
    if (a.currentAction && a.currentAction !== 'idle' && a.currentAction !== 'initializing') {
      ctx.fillStyle = '#555';
      ctx.font = '7px monospace';
      const actionText = a.currentAction.length > 25 ? a.currentAction.slice(0, 25) + '..' : a.currentAction;
      ctx.fillText(actionText, x + radius + 5, y + 13);
    }
  }

  // Draw sync lines between synchronized agents
  if (transitioned) {
    const synced = agents.filter(a => a.synchronized);
    ctx.strokeStyle = 'rgba(168, 85, 247, 0.15)';
    ctx.lineWidth = 0.5;
    for (let i = 0; i < synced.length; i++) {
      for (let j = i + 1; j < synced.length; j++) {
        const a1 = synced[i], a2 = synced[j];
        ctx.beginPath();
        ctx.moveTo(a1.position.x * w / 1000, a1.position.y * h / 800);
        ctx.lineTo(a2.position.x * w / 1000, a2.position.y * h / 800);
        ctx.stroke();
      }
    }
  }
}

function formatTokens(n) {
  if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n / 1000).toFixed(1) + 'k';
  return String(n);
}

async function refresh() {
  try {
    const [stateRes, agentsRes, pheromonesRes, collectiveRes, thoughtsRes, decisionsRes] = await Promise.all([
      fetch(API + '/api/state').then(r => r.json()),
      fetch(API + '/api/agents').then(r => r.json()),
      fetch(API + '/api/pheromones').then(r => r.json()),
      fetch(API + '/api/collective').then(r => r.json()),
      fetch(API + '/api/thoughts').then(r => r.json()).catch(() => []),
      fetch(API + '/api/decisions').then(r => r.json()).catch(() => []),
    ]);

    agents = agentsRes;
    pheromones = pheromonesRes;
    thoughts = thoughtsRes;
    decisions = decisionsRes;

    // Header stats
    document.getElementById('h-step').textContent = stateRes.step;
    document.getElementById('h-pheromones').textContent = stateRes.metrics.totalPheromones;
    document.getElementById('h-discoveries').textContent = stateRes.metrics.totalDiscoveries;
    document.getElementById('h-synced').textContent =
      `${stateRes.metrics.synchronizedCount}/${agentsRes.length}`;
    document.getElementById('h-tokens').textContent = formatTokens(stateRes.totalTokens || 0);
    document.getElementById('h-prs').textContent = stateRes.totalPRs || 0;

    // PR burst effect
    const currentPRs = stateRes.totalPRs || 0;
    if (currentPRs > prevPRCount && prevPRCount > 0) {
      const canvasArea = document.querySelector('.canvas-area');
      const burst = document.createElement('div');
      burst.className = 'pr-burst';
      burst.style.left = '50%';
      burst.style.top = '50%';
      canvasArea.appendChild(burst);
      setTimeout(() => burst.remove(), 1000);
    }
    prevPRCount = currentPRs;

    // Phase transition flash
    if (stateRes.phaseTransitionOccurred && !prevTransition) {
      document.getElementById('flash').classList.add('active');
      document.getElementById('h-transition-wrap').style.display = 'block';
      setTimeout(() => document.getElementById('flash').classList.remove('active'), 2000);
    }
    prevTransition = stateRes.phaseTransitionOccurred;

    // Density meter
    const density = stateRes.density;
    const threshold = stateRes.criticalThreshold;
    const fill = document.getElementById('density-fill');
    fill.style.width = `${density * 100}%`;
    fill.style.background = density >= threshold
      ? 'linear-gradient(90deg, #a855f7, #ec4899)'
      : 'linear-gradient(90deg, #1a1a3e, #4a9eff)';
    document.getElementById('density-label').textContent =
      `Density: ${density.toFixed(3)} / threshold: ${threshold.toFixed(2)}`;
    document.getElementById('critical-line').style.left =
      `calc(20px + ${threshold * 100}% * (100% - 40px) / 100%)`;

    // Agent list — enhanced with current action + PR count
    document.getElementById('agent-list').innerHTML = agentsRes.map((a, i) => {
      const color = getColor(a.id, i);
      const action = a.currentAction || 'idle';
      const actionShort = action.length > 20 ? action.slice(0, 20) + '..' : action;
      return `<div class="agent-item ${a.synchronized ? 'synced' : ''}">
        <div class="agent-dot" style="background:${color}"></div>
        <span class="agent-name">${a.name}</span>
        <span class="agent-action" title="${action}">${actionShort}</span>
        <span class="agent-stat">${a.discoveries}</span>
        ${a.prsCreated > 0 ? `<span class="agent-pr-count">PR:${a.prsCreated}</span>` : ''}
      </div>`;
    }).join('');

    // Collective memories
    if (collectiveRes.length > 0) {
      document.getElementById('collective-list').innerHTML = collectiveRes.slice(-5).reverse().map(m => `
        <div class="memory-item">
          <div class="memory-topic">${m.topic}</div>
          <div class="memory-synthesis">${m.synthesis.slice(0, 200)}...</div>
          <div class="memory-meta">${m.contributors.length} agents | confidence ${m.confidence.toFixed(2)} | ${m.attestation.slice(0, 16)}...</div>
        </div>
      `).join('');
    }

    // Agent Thoughts stream (replaces "Latest Discoveries")
    if (thoughtsRes.length > 0) {
      document.getElementById('thought-feed').innerHTML = thoughtsRes
        .slice(0, 8)
        .map(t => {
          const agent = agentsRes.find(a => a.id === t.agentId);
          const color = agent ? getColor(agent.id) : '#666';
          const actions = (t.suggestedActions || []).slice(0, 2).join(', ');
          return `<div class="thought-item">
            <div class="thought-header">
              <span class="thought-agent" style="color:${color}">${agent?.name || '?'}</span>
              <span class="thought-confidence">${(t.confidence || 0).toFixed(2)}</span>
            </div>
            <div class="thought-conclusion">${(t.conclusion || '').slice(0, 120)}</div>
            ${actions ? `<div class="thought-actions">${actions}</div>` : ''}
          </div>`;
        }).join('');
    } else if (pheromonesRes.length > 0) {
      // Fallback: show pheromone discoveries if no thoughts yet
      document.getElementById('thought-feed').innerHTML = pheromonesRes
        .sort((a, b) => b.timestamp - a.timestamp)
        .slice(0, 8)
        .map(p => {
          const agent = agentsRes.find(a => a.id === p.agentId);
          const color = getColor(p.agentId);
          return `<div class="thought-item">
            <div class="thought-header">
              <span class="thought-agent" style="color:${color}">${agent?.name || '?'}</span>
              <span class="thought-confidence">${p.domain.split(' ').slice(0, 2).join(' ')}</span>
            </div>
            <div class="thought-conclusion">${p.content.slice(0, 120)}...</div>
          </div>`;
        }).join('');
    }

    // Decision Log (bottom panel 1)
    if (decisionsRes.length > 0) {
      document.getElementById('decision-log').innerHTML = decisionsRes
        .slice(0, 12)
        .map(d => {
          const agent = agentsRes.find(a => a.id === d.agentId);
          const color = agent ? getColor(agent.id) : '#666';
          const actionType = d.action?.type || '?';
          const status = d.status || 'pending';
          return `<div style="font-size:0.7em;padding:3px 0;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #0a0a12">
            <span style="color:${color};min-width:55px">${agent?.name || '?'}</span>
            <span style="color:#888;flex:1;margin:0 6px">${actionType}</span>
            <span class="decision-status-${status}">${status}</span>
          </div>`;
        }).join('');
    }

    // GitHub Activity (bottom panel 2)
    const reposStudied = new Set();
    const issuesFound = [];
    const prsCreated = [];
    agentsRes.forEach(a => {
      if (a.prsCreated > 0) prsCreated.push({ name: a.name, count: a.prsCreated });
    });

    // Build GitHub activity from decisions
    const ghEntries = [];
    decisionsRes.forEach(d => {
      const agent = agentsRes.find(a => a.id === d.agentId);
      const name = agent?.name || '?';
      const action = d.action;
      if (!action) return;
      if (action.type === 'study_repo' && action.owner) {
        ghEntries.push({ icon: 'S', label: `${name} studied ${action.owner}/${action.repo}`, color: '#4a9eff' });
      } else if (action.type === 'fix_issue' && action.owner) {
        ghEntries.push({ icon: 'F', label: `${name} fixing #${action.issueNumber} in ${action.owner}/${action.repo}`, color: '#f59e0b' });
      } else if (action.type === 'contribute_pr' && action.owner) {
        ghEntries.push({ icon: 'P', label: `${name} PR for ${action.owner}/${action.repo}`, color: '#10b981' });
      }
    });

    if (ghEntries.length > 0) {
      document.getElementById('github-activity').innerHTML = ghEntries.slice(0, 10).map(e =>
        `<div style="font-size:0.7em;padding:2px 0;color:#666;display:flex;gap:6px;border-bottom:1px solid #0a0a12">
          <span style="color:${e.color};font-weight:bold;min-width:12px">${e.icon}</span>
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${e.label}</span>
        </div>`
      ).join('');
    } else {
      // Fallback: show attestation log
      if (pheromonesRes.length > 0) {
        document.getElementById('github-activity').innerHTML =
          '<div style="font-size:0.6em;color:#333;margin-bottom:6px">ATTESTATION LOG (no GitHub activity yet)</div>' +
          pheromonesRes
          .sort((a, b) => b.timestamp - a.timestamp)
          .slice(0, 10)
          .map(p => {
            const agent = agentsRes.find(a => a.id === p.agentId);
            const color = getColor(p.agentId);
            return `<div style="font-size:0.7em;padding:2px 0;color:#444;display:flex;justify-content:space-between">
              <span style="color:${color}">${agent?.name || '?'}</span>
              <span>${p.attestation.slice(0, 20)}...</span>
            </div>`;
          }).join('');
      }
    }

    // Domain coverage
    const domains = {};
    pheromonesRes.forEach(p => {
      domains[p.domain] = (domains[p.domain] || 0) + 1;
    });
    const sorted = Object.entries(domains).sort((a, b) => b[1] - a[1]);
    if (sorted.length > 0) {
      const max = sorted[0][1];
      document.getElementById('domain-coverage').innerHTML = sorted.map(([d, count]) => {
        const pct = (count / max) * 100;
        return `<div style="margin-bottom:4px">
          <div style="font-size:0.7em;color:#666;margin-bottom:1px">${d}</div>
          <div style="height:4px;background:#1a1a2e;border-radius:2px;overflow:hidden">
            <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,#4a9eff,#a855f7);border-radius:2px"></div>
          </div>
        </div>`;
      }).join('');
    }

    // Draw canvas
    drawSwarm(agentsRes, pheromonesRes, stateRes.phaseTransitionOccurred);
  } catch (e) {
    // Server not ready yet
  }
}

setInterval(refresh, 500);
refresh();
</script>

</body>
</html>
